name: Update Navigation Data

on:
  # å½“æœ‰ä»£ç æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '**/index.html'  # ä»»ä½•åŒ…å«index.htmlçš„æ–‡ä»¶å˜æ›´
      - '!index.html'    # ä½†æ’é™¤æ ¹ç›®å½•çš„index.htmlï¼ˆé¦–é¡µï¼‰
      - '**/README.md'
      - '**/*.md'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 2 * * *'

jobs:
  update-navigation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºæ£€æµ‹æ–‡ä»¶å˜æ›´
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # å¦‚æœæœ‰å…¶ä»–ä¾èµ–ï¼Œåœ¨è¿™é‡Œå®‰è£…
        # pip install -r requirements.txt
    
    - name: Run Navigation Generator
      run: |
        python3 navigation_generator.py
        echo "å¯¼èˆªæ•°æ®ç”Ÿæˆå®Œæˆ"
    
    - name: Check if navigation data changed
      id: check-changes
      run: |
        if git diff --quiet HEAD -- navigation_data.json; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å¯¼èˆªæ•°æ®å˜æ›´"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°å¯¼èˆªæ•°æ®å˜æ›´"
          git diff navigation_data.json
        fi
    
    - name: Commit and push changes
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add navigation_data.json
        git commit -m "ğŸ¤– Auto-update navigation data [skip ci]" || echo "No changes to commit"
        git push
    
    - name: Create Pull Request
      if: steps.check-changes.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ¤– Auto-update navigation data"
        title: "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¯¼èˆªæ•°æ®"
        body: |
          ## ğŸ¤– è‡ªåŠ¨æ›´æ–°æŠ¥å‘Š
          
          å¯¼èˆªæ•°æ®å·²è‡ªåŠ¨æ›´æ–°ï¼ŒåŒ…æ‹¬ï¼š
          - æ–°å¢çš„å†…é¡µå·¥å…·
          - åˆ†ç±»ä¿¡æ¯æ›´æ–°
          - ç»Ÿè®¡æ•°æ®åˆ·æ–°
          
          ### ğŸ“Š æ›´æ–°è¯¦æƒ…
          - æ›´æ–°æ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - è§¦å‘è€…: ${{ github.actor }}
          - æäº¤æ¶ˆæ¯: ${{ github.event.head_commit.message }}
          
          ### ğŸ“ å˜æ›´æ–‡ä»¶
          - `navigation_data.json` - å¯¼èˆªæ•°æ®æ–‡ä»¶
          
          ---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
        branch: auto-update-navigation
        delete-branch: true
        add-paths: navigation_data.json

    - name: Upload navigation data as artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: navigation-data
        path: navigation_data.json
        retention-days: 30

    - name: Post summary
      run: |
        if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
          echo "âœ… å¯¼èˆªæ•°æ®å·²æˆåŠŸæ›´æ–°"
        else
          echo "â„¹ï¸  æ— éœ€æ›´æ–°å¯¼èˆªæ•°æ®"
        fi
